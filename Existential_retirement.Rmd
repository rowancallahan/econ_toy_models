---
title: "An Existential Look at Stocks and Retirement"
author: "Rowan Callahan"
date: "January 27, 2019"
output: 
  html_document:
    mathjax: default
runtime: shiny
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
```
This is an RShiny [Interactive Document](http://rmarkdown.rstudio.com/authoring_shiny.html)

## What is Investing?
[Investing](https://en.wiktionary.org/wiki/investment) usually refers to any strategy of using money to generate more money. The goal is usually to buy something with the hope that it will be worth more later. Most people when they talk about investing mean investing in stocks and or bonds so that they have enough money at the end of their working career to retire.

I will be using `rshiny` and `rmarkdown` to explore the assumptions behind investing and hopefully have some fun while getting a little bit ~existential~ about the whole idea of investing!

Most people view investments as a simple matter of exponential growth.

You put in x amount of money and it will increase with compound interest year after year until the manageable amount you put in has become large enough to retire and support you into old age. Most retirement calculators work based off this assumption of exponential growth, and they look something like this.

For those who are a little less familiar with exponential growth, and the main advertising behind investment banking the basic equation is as follows.

$$m_t = Xe^{kt} $$
Money at time t is equivalent to the growth rate K the amount of money you start with and the amount of time that has passed.


```{r, echo=FALSE}
library(shiny)
inputPanel(
   sliderInput("increase", label = "percent yearly increase",
              min = -1, max = 15, value = 6, step = 0.2),
   sliderInput("contrib",label = "income saved per month",
               min = 0, max = 10000, value = 500, step = 250)
)

money <- reactive({
  c <- input$contrib * 12 #money contributed per year
  k <- (input$increase/100) #percent increase per year
  a <- c/k #for use in the solved equation
  return <- function(x){(a * exp(k*x)) - a}
})

renderPlot({
  plot(money()(0:35),type='l')
})


```

However when pressed any investment professional will tell you that there is an element of randomness to the stock market (understatement of the year) that doesn't always cooperate with the retiree.

Some people prefer to view stock market motions as a random walk. Where
the value is a sum of random movements. Each random movement is considered to be part of a "normal distribution"

$$ X \sim N{(\mu,\sigma)} $$

This can be read as X is distributed according to the normal distribution with mean mu and variance sigma.

Below is an example of what a "normal" also known as a gaussian distribution looks like.


```{r, echo=FALSE}
library(shiny)
inputPanel(
  selectInput("mean", label = "mean",
              choices = c(-1, 0, 1, 2), selected = 0),
  
  sliderInput("variance", label = "variance",
              min = 0.2, max = 8, value = 1, step = 0.2)
)
samples <- reactive({
  data_in <- rnorm(300,mean=as.numeric(input$mean), 
                   sd=as.numeric(input$variance))
  return <- data_in
})

renderPlot({
  hist(samples(), probability = TRUE,
       xlab = "Change in value", main = "The distribution for a gaussian random walk")
  
})

```

So what happens when we take a random distribution and see how it stacks up when we see how a bunch of small random changes with a positive mean. This is called a random walk, or more specifically Brownian motion. Some people like to think of the stock market as an example of random movements either up or down.

```{r,echo=FALSE}

renderPlot({
  plot(cumsum(samples()),type='l')
})

```

To move this back into the realm of exponential growth, which some people seem to think of as a more accurate portrayal of the stock market.


```{r, echo=FALSE}
library(shiny)

inputPanel(
   sliderInput("stoch_increase", label = "average point increase per year",
              min = 0.0, max = 2, value = 0.35, step = 0.05),
   sliderInput("freq",label = "how many times to measure per year",
               min = 2, max = 12 , value = 2, step = 2),
   sliderInput("sd",label="how much crazy are these theoretical markets?",
               min=0, max=0.5, value=0.25, step=0.05)
)

stock_move<- reactive({
  set.seed(4)
  data_in <- rnorm(input$freq*35,
                   mean=input$stoch_increase/input$freq, 
                   sd=input$sd)
  return <- data_in
})

renderPlot({
  plot(exp(cumsum(stock_move())),type='l')
  plot(money(), 0, 70,add=TRUE)
})

```


Now lets look at some actual market data and see how people actually did assuming that they put all of their investments into stocks when they turned 25 and retired when they were at least 60. How did their money turn out

Just to make things a little more fun lets decide when you are going to start and when you are going to stop investing. Give us a start date and an end date!

```{r, echo=FALSE}
library(shiny)
library(purrr)
library(ggplot2)

stocks<-read.csv("./sp_data.csv",row.names=1)
stocks<-stocks[order(stocks$time),]

add_stock<- function(stock_amount, stock_price){
  dollars_to_add <- 300
  #This the assumption that you buy 300 dollars of s+p each month
  #This needs to be changed to be modifiable, 
  new_amount <- stock_amount + (dollars_to_add/stock_price)
  return(new_amount)}

stocks$date <- as.Date(stocks$time, format = "%Y-%m-%d")


inputPanel(
  dateInput("startdate", label = h2("Time travel start point"), value = "1910-01-01"),
  dateInput("stopdate", label = h2("Time travel retirement"), value = "1950-01-01"),
  hr(),
  fluidRow(column(3, verbatimTextOutput("value")))
)
subset_stocks <- reactive({
  time_bound <- subset(stocks, stocks$date > input$startdate & stocks$date < input$stopdate)
 
  time_bound$amount <- accumulate(as.numeric(time_bound$Value.Value), add_stock)

  time_bound$money <- time_bound$amount * as.numeric(time_bound$Value.Value)

  return <- time_bound 
})

percent_increase <- reactive({
 months <- length(subset_stocks()$money)
 money_in <- months * 300
 money_final <- tail(subset_stocks()$money,n=1)
 return <- as.character( (money_final/money_in - 1)*100)
})

exponential_comparison <- reactive({
#  years <- difftime(input$stopdate,input$startdate, units="days")
#  c <- 300 * 12 #money contributed per year
#  k <- (input$increase/100) #percent increase per year
#  a <- c/k #for use in the solved equation
#  c/k * exp(k*x) - c/k
#  return <- function(x){(a * exp(k*x)) - a}
})

renderText(paste0("your money increased by ",percent_increase(),"% compared to what you would have if you just stuffed it under your matress"))
```

Ok so you are aware of the risks of investing with our fabulous hedge fund but you roll the dice and invest anyway, how did you do within the years that you specified?

Did you make a good return? Was it all worth it?

```{r, echo=FALSE}

renderPlot({
#  plot(data$time,data$Value.Value,type='l')
#  par(new=TRUE)
#  plot(stocks$time,stock_money)
  ggplot(data=subset_stocks(), aes(x=date, y=money, group=1)) +
  geom_line()+
  ylab("Retirement Fund Value")
})

renderPlot({
  ggplot(data=subset_stocks(), aes(x=date, y=Value.Value, group=1)) +
  geom_smooth() +
  geom_line() + 
  ylab("Stock Market Value")
  #scale_x_date(date_breaks="5 years", date_labels = "%b-%y")
})

renderPlot({
  ggplot(data=subset_stocks(), aes(x=date, y=amount,group=1)) + 
  geom_line() +
  ylab("Number of S+P Shares in retirement fund")
})

```


